name: Code Metrics Analysis

on:
  push:
    branches: [main, develop, "feature/**"]
  pull_request:
    branches: [main]

env:
  METRICS_SERVICE_URL: ${{ secrets.METRICS_SERVICE_URL }}

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  analyze:
    name: Analyze Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare push payload
        id: payload
        run: |
          REPO_NAME="${{ github.repository }}"
          REPO_URL="https://github.com/${{ github.repository }}.git"
          BRANCH="${{ github.ref_name }}"
          HEAD_SHA="${{ github.sha }}"
          PUSHER="${{ github.actor }}"

          COMMIT_MSG=$(git log -1 --pretty=format:'%s' | head -c 200)
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')

          ADDED=$(git diff --name-only --diff-filter=A HEAD~1 HEAD 2>/dev/null | jq -R . | jq -s . 2>/dev/null || echo '[]')
          MODIFIED=$(git diff --name-only --diff-filter=M HEAD~1 HEAD 2>/dev/null | jq -R . | jq -s . 2>/dev/null || echo '[]')
          REMOVED=$(git diff --name-only --diff-filter=D HEAD~1 HEAD 2>/dev/null | jq -R . | jq -s . 2>/dev/null || echo '[]')

          PAYLOAD=$(jq -n \
            --arg repo_name "$REPO_NAME" \
            --arg repo_url "$REPO_URL" \
            --arg branch "$BRANCH" \
            --arg head_sha "$HEAD_SHA" \
            --arg pusher "$PUSHER" \
            --arg sha "$HEAD_SHA" \
            --arg message "$COMMIT_MSG" \
            --arg author "$COMMIT_AUTHOR" \
            --argjson added "$ADDED" \
            --argjson modified "$MODIFIED" \
            --argjson removed "$REMOVED" \
            '{
              repo_name: $repo_name,
              repo_url: $repo_url,
              branch: $branch,
              head_sha: $head_sha,
              pusher: $pusher,
              commits: [{
                sha: $sha,
                message: $message,
                author: $author,
                added: $added,
                modified: $modified,
                removed: $removed
              }]
            }')

          echo "payload<<EOF" >> $GITHUB_OUTPUT
          echo "$PAYLOAD" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Code Metrics Service
        id: analyze
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${METRICS_SERVICE_URL}/api/analyze" \
            -H "Content-Type: application/json" \
            -d '${{ steps.payload.outputs.payload }}')

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$ d')

          echo "HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Code Metrics analysis failed with HTTP $HTTP_CODE"
            exit 1
          fi

          SCORE=$(echo "$BODY" | jq -r '.quality_score')
          INTEGRITY=$(echo "$BODY" | jq -r '.integrity')
          REPORT_URL=$(echo "$BODY" | jq -r '.report_url')
          OPINION=$(echo "$BODY" | jq -r '.claude_review.summary // "No summary"')
          TREND_DIR=$(echo "$BODY" | jq -r '.trend.direction // "stable"')
          TREND_DELTA=$(echo "$BODY" | jq -r '.trend.quality_delta // 0')
          TREND_SUMMARY=$(echo "$BODY" | jq -r '.trend.summary // "No trend data"')

          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "integrity=$INTEGRITY" >> $GITHUB_OUTPUT
          echo "report_url=${METRICS_SERVICE_URL}${REPORT_URL}" >> $GITHUB_OUTPUT
          echo "opinion=$OPINION" >> $GITHUB_OUTPUT
          echo "trend_dir=$TREND_DIR" >> $GITHUB_OUTPUT
          echo "trend_delta=$TREND_DELTA" >> $GITHUB_OUTPUT
          echo "trend_summary=$TREND_SUMMARY" >> $GITHUB_OUTPUT

          echo "$BODY" > analysis-result.json

      - name: Download Markdown Report
        run: |
          curl -s "${METRICS_SERVICE_URL}${{ steps.analyze.outputs.report_url }}" \
            -o code-metrics-report.md || true

      - name: Upload Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: code-metrics-report
          path: |
            code-metrics-report.md
            analysis-result.json
          retention-days: 30

      - name: Post Summary to Job
        run: |
          SCORE="${{ steps.analyze.outputs.score }}"
          INTEGRITY="${{ steps.analyze.outputs.integrity }}"
          OPINION="${{ steps.analyze.outputs.opinion }}"
          REPORT="${{ steps.analyze.outputs.report_url }}"
          TREND_DIR="${{ steps.analyze.outputs.trend_dir }}"
          TREND_DELTA="${{ steps.analyze.outputs.trend_delta }}"

          if [ "$TREND_DIR" = "improving" ]; then
            TREND_ICON="ðŸ“ˆ Improving (+${TREND_DELTA})"
          elif [ "$TREND_DIR" = "declining" ]; then
            TREND_ICON="ðŸ“‰ Declining (${TREND_DELTA})"
          else
            TREND_ICON="âž¡ï¸ Stable"
          fi

          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## Code Metrics Analysis

          | Metric | Value |
          |--------|-------|
          | **Quality Score** | **${SCORE}/100** |
          | **Integrity** | ${INTEGRITY} |
          | **Trend** | ${TREND_ICON} |
          | **Claude Opinion** | ${OPINION} |

          [View Full Report](${REPORT})

          ---
          *Analyzed by Code Metrics + Claude AI*
          EOF

      - name: Post Claude opinion as commit comment
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let result;
            try {
              result = JSON.parse(fs.readFileSync('analysis-result.json', 'utf8'));
            } catch (e) {
              console.log('No analysis result file found');
              return;
            }

            const score = result.quality_score || 0;
            const trend = result.trend || {};
            const review = result.claude_review || {};
            const metrics = result.metrics || {};
            const reportUrl = '${{ steps.analyze.outputs.report_url }}';

            let trendIcon = 'âž¡ï¸ Stable';
            if (trend.direction === 'improving') {
              trendIcon = `ðŸ“ˆ Improving (+${(trend.quality_delta || 0).toFixed(1)})`;
            } else if (trend.direction === 'declining') {
              trendIcon = `ðŸ“‰ Declining (${(trend.quality_delta || 0).toFixed(1)})`;
            }

            let scoreEmoji = 'ðŸŸ¢';
            if (score < 50) scoreEmoji = 'ðŸ”´';
            else if (score < 70) scoreEmoji = 'ðŸŸ¡';

            let body = `## ${scoreEmoji} Code Metrics Analysis

            | Metric | Value |
            |--------|-------|
            | **Quality Score** | **${score}/100** |
            | **Integrity** | ${result.integrity || 'unknown'} |
            | **Trend** | ${trendIcon} |
            | **Lines** | +${metrics.lines_added || 0} / -${metrics.lines_deleted || 0} |
            | **Complexity** | ${metrics.complexity_avg || 0} |
            | **Maintainability** | ${metrics.maintainability_index || 0}/100 |`;

            if (review.opinion) {
              const opinion = review.opinion.substring(0, 1500);
              body += `\n\n### Claude AI Opinion\n${opinion}`;
            }

            if (review.suggestions && review.suggestions.length > 0) {
              body += `\n\n### Suggestions\n${review.suggestions.map(s => '- ' + s).join('\n')}`;
            }

            if (review.security) {
              body += `\n\n### Security Notes\n${review.security}`;
            }

            if (trend.summary) {
              body += `\n\n### Codebase Trend\n${trend.summary}`;
            }

            body += `\n\n[View Full Report](${reportUrl})\n\n---\n*Automated analysis by Code Metrics + Claude AI*`;

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: body
            });

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let result;
            try {
              result = JSON.parse(fs.readFileSync('analysis-result.json', 'utf8'));
            } catch (e) {
              return;
            }

            const score = result.quality_score || 0;
            const trend = result.trend || {};
            const review = result.claude_review || {};
            const reportUrl = '${{ steps.analyze.outputs.report_url }}';

            let scoreEmoji = 'ðŸŸ¢';
            if (score < 50) scoreEmoji = 'ðŸ”´';
            else if (score < 70) scoreEmoji = 'ðŸŸ¡';

            let trendIcon = 'âž¡ï¸ Stable';
            if (trend.direction === 'improving') trendIcon = `ðŸ“ˆ +${(trend.quality_delta||0).toFixed(1)}`;
            else if (trend.direction === 'declining') trendIcon = `ðŸ“‰ ${(trend.quality_delta||0).toFixed(1)}`;

            const body = `## ${scoreEmoji} Code Metrics Analysis

            | Metric | Value |
            |--------|-------|
            | **Quality Score** | **${score}/100** |
            | **Integrity** | ${result.integrity || 'unknown'} |
            | **Trend** | ${trendIcon} |

            ### Claude AI Opinion
            ${(review.opinion || review.summary || 'No review available').substring(0, 2000)}

            [View Full Report](${reportUrl})

            ---
            *Automated analysis by Code Metrics + Claude AI*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail on low quality
        if: ${{ steps.analyze.outputs.score < 30 }}
        run: |
          echo "::error::Quality score (${{ steps.analyze.outputs.score }}) is below minimum threshold (30)"
          exit 1

      - name: Fail on integrity issues
        if: ${{ steps.analyze.outputs.integrity == 'fail' }}
        run: |
          echo "::error::Integrity check failed! Possible secrets or critical issues detected."
          exit 1
